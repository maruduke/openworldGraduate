# 유니티를 통한 모바일 오픈 월드 개발

## 1. 연구 배경
  유니티는 현재 모바일 게임 시장에서 높은 점유율을 가진 게임 엔진이다. 유나이트 2022 컨퍼런스 발표내용에 따르면 현재 상위 1000개 모바일 게임 중 유니티 기반이 72%로 개발되었다. 유니티가 이러한 위상을 가질 수 있는 이유는 크게 다음과 같다.
  </br>
  </br>
  
  첫 번째, 엔진과 에디터가 결합 되어 배울 수 있는 유니티 엔진은 게임 개발 입문자들에게 입문하기 쉽게 만들었으며 스크립트 언어로는 C#을 채택하여 작성 시 C++에서 어려웠던 메모리 관리 문제를 대응하기 쉽게 되어 생산성이 높아지게 되었다.   
  <br/>
  두 번째, 개발 시 모바일, 콘솔 등 다양한 플랫폼을 동시에 지원한다는 점이 있다. 그 외에도 필요한 리소스를 에셋 스토어와 같은 유니티 특유의 생태계에서 구할 수 있다는 점, 활성화된 커뮤니티 등이 존재하여 접근성이 크다.  
  <br/>
  이러한 장점에도 유니티를 통한 게임 개발 시 퍼즐, 슈팅, 로그라이크와 같은 가벼운 게임 장르위주로 개발되고 있다. 모바일 게임 시장내 가벼운 게임 개발의 원인으로 본 연구에서는 리소스 생성과 고급 관리 기능 지원의 부족으로 판단하였다. 특히나 모바일 플랫폼의 경우 하드웨어의 제약이 존재하므로 더욱 리소스 관리에 대한 필요성이 존재하기에 **모바일 플랫폼을 향한 게임 개발의 어려움을 해소하고자 방향성을 제안하기 위하여 본 연구를 진행하였다.**

## 2. 연구 목적
  본 연구는 유니티 엔진을 통한 소수의 개발자가 모바일 오픈월드 개발 도전을 목표로 한다. 오픈월드 제작에 필요한 다수의 노동력의 문제를 최소화하는 방안과 더불어 모바일 개발하는 동안 오픈월드 장르의 대용량 처리가 필요함에 따른 리소스 관리를 효율적으로 제어하는 방향성을 제안하고자 한다. 그와 관련된 연구는 다음과 같다.
  <br/><br/>
  첫 번째, **오픈월드 맵 구성을 자동으로 생성한다.** 월드의 생성은 오픈월드의 구성요소인 대용량 맵을 자동으로 생성함으로써 필요한 노동력을 감소하는 것을 목표로 한다. 해당 맵은 노이즈 함수를 통하여 다양한 형태의 맵을 자동으로 구성된다.
  <br/><br/>
  두 번째, 방대한 크기를 가지는 월드와 오브젝트를 가지는 오픈월드를 모바일 플랫폼에서 구동하기 위해 월드를 분할 관리를 통한 **안정적인 메모리 관리**한다. 또한 메모리 로딩 과정에서 발생하는 **CPU과점유로 인한 프레임 드랍을 방지**하기 위해 최적화를 적용한다.

## 3. 팀원 소개

|이름| 역할| 담당 기능|
|--|--|--|
| 이경석 | 최적화 | 1. 모바일 환경 CPU 안정화 적용 <br> 2. 모바일 메모리 최적화 관리 <br> |
| 이성민| 맵 개발 | 1. 픽셀형 맵 자동 생성 알고리즘 <br> 2. 맵 좌표 관리 시스템 <br>  |
## 4. 개발 내용

### 4.1 월드 맵 자동 생성

우선 월드맵을 청크(chunk)라는 영역으로 분할하여 월드맵을 구성.
해당 청크는 두 가지 작업을 진행하여 생성된다.  

1. 절차적 생성 알고리즘인 Perlin 노이즈 함수를 사용하여 위치에 따른 청크의 특징을 구성  
2. 높이를 계산하기 위해 삼각파와 가우스 함수가 결합된 합성함수 값과 Perlin noise의 값을 통하여 높이를 계산
  
청크 내부는 인접한 블록들을 제외하여 보여지는 영역인 외부만 표현할 수 있는 작업을 진행하여 크기를 감소  

 <p align="center">
   <img style="margin:50px 0 10px 0" src="https://github.com/user-attachments/assets/d91c202e-8458-4a1f-95b3-83ed330bd73b"/>
</p>


### 4.2 메모리 관리

오픈월드의 방대한 맵과 많은 오브젝트는 거대한 용량을 가진다. 해당 데이터 전체를 메모리에 올리는 것은 모바일 메모리 성능으로는 제약이 따른다. 따라서 필요한 데이터를 선별적으로 메모리에 적재한다.  
  
![image](https://github.com/user-attachments/assets/629b57eb-14f9-4e6b-958b-b0e93b3b0bf7)

오브젝트 관리 시스템에서는 맵과 오브젝트를 특정 영역을 기준으로 분할하여 관리한다. 해당 **분할된 영역 단위를 씬(Scene)** 이라고 부른다. 플레이어 위치를 기반으로 하여 일정 거리 내부에 존재하는 씬을 관리 시스템이 관리를 시작한다. 씬이 관리 시스템을 통해 생성될 때 맵 데이터와 오브젝트 데이터의 디스크 저장 위치를 가지고 있다. 씬 영역은 플레이어가 이동하면서 일정거리 이상 가까워지면 가지고 있는 디스크 저장 위치의 맵과 오브젝트를 가져와 렌더링하여 플레이어에게 인식된다. 플레이어 위치가 씬에서 일정거리 이상 멀어진다면 씬 내부의 데이터를 전부 삭제함으로써 메모리 총량을 일정하게 유지한다.  

### 4.3 CPU 성능 최적화


![image](https://github.com/user-attachments/assets/6433301c-9682-4bfd-b0af-933e7d9ac049)


### 4.4 HLOD 적용 및 커스터마이징

## 5. 결과

### 5.1 맵 생성
![image](https://github.com/user-attachments/assets/89f5747e-acef-495c-a9ce-b8c1aac50f8d)
![image](https://github.com/user-attachments/assets/a6979fb7-3e00-4358-b821-d8c38319435a)

### 5.2 메모리 관리

![image](https://github.com/user-attachments/assets/a845a392-bffe-4910-a646-ea60eb9b8e7c)
메모리 실시간 점유율


### 5.3 CPU 점유율
![image](https://github.com/user-attachments/assets/18972ef1-8e30-41c1-942e-5b3b4c9eca2d)

